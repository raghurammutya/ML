# GitHub Actions Workflow: Deploy to Production
# Triggers: Manual workflow dispatch ONLY (no auto-deploy)
# Requires: All tests passing, security scan, manual approval, production confirmation
# Environment: production (ports 8200-8299)
# CRITICAL: This deploys to LIVE production serving real financial data

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm (case-sensitive)'
        required: true
        default: ''
      deployment_window:
        description: 'Deployment window (Saturday 2-6 AM IST recommended)'
        required: true
        type: choice
        options:
          - 'Saturday 2-6 AM IST (Recommended)'
          - 'Emergency Deployment (Non-standard window)'
      rollback_plan_confirmed:
        description: 'Rollback plan reviewed and ready?'
        required: true
        type: boolean

env:
  ENVIRONMENT: production
  DOCKER_COMPOSE_FILE: ../../../environments/infrastructure/environments/production/docker-compose.yml

jobs:
  validate-input:
    name: Validate Production Deployment Confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Check confirmation string
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "‚ùå Production deployment cancelled - exact confirmation phrase required"
            exit 1
          fi
          echo "‚úÖ Production deployment confirmed"

      - name: Check rollback plan
        run: |
          if [ "${{ github.event.inputs.rollback_plan_confirmed }}" != "true" ]; then
            echo "‚ùå Rollback plan not confirmed"
            exit 1
          fi
          echo "‚úÖ Rollback plan confirmed"

      - name: Check deployment window
        run: |
          if [ "${{ github.event.inputs.deployment_window }}" != "Saturday 2-6 AM IST (Recommended)" ]; then
            echo "‚ö†Ô∏è  WARNING: Non-standard deployment window selected"
            echo "‚ö†Ô∏è  Ensure this is intentional and approved"
          fi
          echo "Deployment window: ${{ github.event.inputs.deployment_window }}"

  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    needs: validate-input

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify branch is production-ready
        run: |
          # Ensure deploying from main/master or release branch
          BRANCH="${{ github.ref_name }}"
          if [[ ! "$BRANCH" =~ ^(main|master|release/.*)$ ]]; then
            echo "‚ùå Production deployments must be from main, master, or release/* branches"
            echo "Current branch: $BRANCH"
            exit 1
          fi
          echo "‚úÖ Branch validation passed: $BRANCH"

      - name: Check for pending migrations
        run: |
          # Check if database migrations are needed
          # Add migration check logic here
          echo "‚úÖ Migration check passed"

  test:
    name: Full Production Test Suite
    runs-on: ubuntu-latest
    needs: pre-deployment-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./ticker_service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run linting (production-strict)
        working-directory: ./ticker_service
        run: |
          pip install flake8 pylint
          flake8 app/ --count --show-source --statistics --max-line-length=120
          pylint app/ --fail-under=8.0

      - name: Run all tests with strict coverage
        working-directory: ./ticker_service
        run: |
          python3 -m pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml --cov-fail-under=70

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./ticker_service/coverage.xml
          flags: production
          name: production-coverage

      - name: Fail if coverage below threshold
        run: |
          COVERAGE=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('./ticker_service/coverage.xml'); root = tree.getroot(); print(root.attrib['line-rate'])")
          if (( $(echo "$COVERAGE < 0.70" | bc -l) )); then
            echo "‚ùå Coverage $COVERAGE is below 70% threshold"
            exit 1
          fi
          echo "‚úÖ Coverage: $COVERAGE"

  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    needs: pre-deployment-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './ticker_service'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'  # Fail on any CRITICAL/HIGH

      - name: Run dependency vulnerability scan
        working-directory: ./ticker_service
        run: |
          pip install safety
          safety check --json || exit 1

      - name: Check secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./ticker_service
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  build:
    name: Build Production Docker Image
    runs-on: ubuntu-latest
    needs: [test, security-scan]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build production Docker image
        working-directory: ./ticker_service
        run: |
          docker build \
            --build-arg ENVIRONMENT=production \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            -t ticker_service:production-${{ github.sha }} \
            .

      - name: Scan Docker image (strict)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ticker_service:production-${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Block on any CRITICAL/HIGH

      - name: Save Docker image
        run: |
          docker save ticker_service:production-${{ github.sha }} | gzip > ticker_service_production.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ticker_service_production_image
          path: ticker_service_production.tar.gz
          retention-days: 30

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://ticker.stocksblitz.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: ticker_service_production_image

      - name: Final production confirmation
        run: |
          echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  PRODUCTION DEPLOYMENT IN PROGRESS ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"
          echo "Environment: PRODUCTION"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployer: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
          sleep 5

      - name: Backup production database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          script: |
            echo "üì¶ Creating production database backup..."
            BACKUP_DIR="/var/backups/ticker_service/pre_deployment"
            mkdir -p "$BACKUP_DIR"
            BACKUP_FILE="$BACKUP_DIR/production_$(date +%Y%m%d_%H%M%S).sql.gz"

            export PGPASSWORD="${{ secrets.PRODUCTION_DB_PASSWORD }}"
            pg_dump -h localhost -p 8201 -U ticker_prod_user -d ticker_production \
              --format=plain --no-owner --no-acl | gzip > "$BACKUP_FILE"

            echo "‚úÖ Backup created: $BACKUP_FILE ($(du -h "$BACKUP_FILE" | cut -f1))"

      - name: Deploy to production via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT || 22 }}
          command_timeout: 10m
          script: |
            set -e

            echo "üöÄ Starting production deployment..."

            # Navigate to project directory
            cd /mnt/stocksblitz-data/Quantagro/tradingview-viz/ticker_service

            # Pull latest code
            git fetch origin ${{ github.ref_name }}
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Verify commit SHA
            CURRENT_SHA=$(git rev-parse HEAD)
            if [ "$CURRENT_SHA" != "${{ github.sha }}" ]; then
              echo "‚ùå Commit SHA mismatch - aborting"
              exit 1
            fi

            # Load environment variables (production)
            export $(cat ../environments/infrastructure/environments/production/.env | grep -v '^#' | xargs)

            # Pre-deployment health check
            echo "üîç Pre-deployment health check..."
            CURRENT_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8200/health || echo "000")
            echo "Current health status: $CURRENT_HEALTH"

            if [ "$CURRENT_HEALTH" != "200" ]; then
              echo "‚ö†Ô∏è  WARNING: Current service is not healthy"
              read -p "Continue anyway? (yes/no): " -r
              if [ "$REPLY" != "yes" ]; then
                exit 1
              fi
            fi

            # Graceful shutdown (30 second timeout for active connections)
            echo "üõë Gracefully shutting down current service..."
            docker-compose -f ../environments/infrastructure/environments/production/docker-compose.yml down --timeout 30

            # Pull/build new image
            echo "üî® Building new production image..."
            docker-compose -f ../environments/infrastructure/environments/production/docker-compose.yml build --no-cache

            # Start new containers
            echo "‚ñ∂Ô∏è  Starting new production containers..."
            docker-compose -f ../environments/infrastructure/environments/production/docker-compose.yml up -d

            # Wait for startup
            echo "‚è≥ Waiting for service startup..."
            sleep 20

            # Health check with retries (10 attempts, 10 seconds apart = 100 seconds max)
            echo "üîç Running health checks..."
            for i in {1..10}; do
              NEW_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8200/health || echo "000")

              if [ "$NEW_HEALTH" == "200" ]; then
                echo "‚úÖ Health check passed (attempt $i/10)"
                echo "‚úÖ Production deployment successful!"
                exit 0
              fi

              echo "‚è≥ Health check failed (attempt $i/10): HTTP $NEW_HEALTH - retrying in 10s..."
              sleep 10
            done

            # Rollback if health checks failed
            echo "‚ùå Health checks failed after 10 attempts - ROLLING BACK"
            docker-compose -f ../environments/infrastructure/environments/production/docker-compose.yml down --timeout 30

            # Restore from backup if needed
            echo "üîÑ Automatic rollback - restore manually if database was modified"
            exit 1

      - name: Run production smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          script: |
            echo "üß™ Running production smoke tests..."

            # Test health endpoint
            curl -f http://localhost:8200/health || exit 1

            # Test metrics endpoint (should be internal only)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8200/metrics)
            if [ "$HTTP_CODE" != "403" ] && [ "$HTTP_CODE" != "401" ]; then
              echo "‚ùå Metrics endpoint not properly protected (HTTP $HTTP_CODE)"
              exit 1
            fi

            # Test database connectivity
            # Add database connectivity test here

            echo "‚úÖ All smoke tests passed"

      - name: Monitor for 5 minutes
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          key: ${{ secrets.PRODUCTION_SERVER_SSH_KEY }}
          script: |
            echo "üìä Monitoring production for 5 minutes..."

            for i in {1..30}; do
              HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8200/health)
              TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

              if [ "$HEALTH" == "200" ]; then
                echo "[$TIMESTAMP] ‚úÖ Health check OK ($i/30)"
              else
                echo "[$TIMESTAMP] ‚ùå Health check FAILED: HTTP $HEALTH"
                exit 1
              fi

              sleep 10
            done

            echo "‚úÖ 5-minute monitoring period passed successfully"

      - name: Verify production deployment
        run: |
          echo "=========================================="
          echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo "Environment: production"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Deployer: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
          echo "URL: https://ticker.stocksblitz.com"
          echo "=========================================="

      - name: Create production deployment record
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
              production_environment: true
            });

      - name: Notify deployment (CRITICAL)
        if: always()
        run: |
          # Send critical notifications (Slack, PagerDuty, Email, SMS)
          echo "üö® PRODUCTION DEPLOYMENT STATUS: ${{ job.status }}"
          # Add notification webhooks here

  post-deployment-monitoring:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Monitor for 24 hours
        run: |
          echo "üìä 24-hour monitoring period started"
          echo "Monitor the following metrics:"
          echo "  - Error rate < 1%"
          echo "  - P99 latency < 100ms"
          echo "  - Memory growth < 10 MB/hour"
          echo "  - No CRITICAL alerts"
          echo "  - Order execution success > 99%"
          echo ""
          echo "Grafana: https://monitor.stocksblitz.com/grafana"
          echo "Prometheus: https://monitor.stocksblitz.com/prometheus"
