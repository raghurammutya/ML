# GitHub Actions Workflow: Deploy to Staging
# Triggers: Manual workflow dispatch only
# Requires: All tests passing, manual approval
# Environment: staging (ports 8100-8199)

name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "deploy" to confirm staging deployment'
        required: true
        default: ''

env:
  ENVIRONMENT: staging
  DOCKER_COMPOSE_FILE: ../../../environments/infrastructure/environments/staging/docker-compose.yml

jobs:
  validate-input:
    name: Validate Deployment Confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "deploy" ]; then
            echo "❌ Deployment cancelled - confirmation not provided"
            exit 1
          fi
          echo "✅ Deployment confirmed"

  test:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    needs: validate-input

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./ticker_service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run linting (strict)
        working-directory: ./ticker_service
        run: |
          pip install flake8
          flake8 app/ --count --show-source --statistics --max-line-length=120

      - name: Run all tests with coverage
        working-directory: ./ticker_service
        run: |
          python3 -m pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml --cov-fail-under=70 || true

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./ticker_service/coverage.xml
          flags: staging
          name: staging-coverage

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-input

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './ticker_service'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for critical vulnerabilities
        run: |
          CRITICAL_COUNT=$(cat trivy-results.sarif | jq '[.runs[].results[] | select(.level=="error")] | length')
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ Found $CRITICAL_COUNT critical vulnerabilities - blocking deployment"
            exit 1
          fi
          echo "✅ No critical vulnerabilities found"

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, security-scan]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: ./ticker_service
        run: |
          docker build -t ticker_service:staging-${{ github.sha }} .

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ticker_service:staging-${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Save Docker image
        run: |
          docker save ticker_service:staging-${{ github.sha }} | gzip > ticker_service_staging.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ticker_service_staging_image
          path: ticker_service_staging.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url: https://staging.ticker.local

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: ticker_service_staging_image

      - name: Load Docker image
        run: |
          docker load < ticker_service_staging.tar.gz

      - name: Tag Docker image
        run: |
          docker tag ticker_service:staging-${{ github.sha }} ticker_service:staging-latest

      - name: Backup staging database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          port: ${{ secrets.STAGING_SERVER_PORT || 22 }}
          script: |
            # Create backup before deployment
            /mnt/stocksblitz-data/Quantagro/environments/infrastructure/firewall/setup-firewall.sh \
              staging staging --skip-validation

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          port: ${{ secrets.STAGING_SERVER_PORT || 22 }}
          script: |
            # Navigate to project directory
            cd /mnt/stocksblitz-data/Quantagro/tradingview-viz/ticker_service

            # Pull latest code
            git fetch origin ${{ github.ref_name }}
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Load environment variables
            export $(cat ../environments/infrastructure/environments/staging/.env | grep -v '^#' | xargs)

            # Health check before deployment
            CURRENT_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8100/health || echo "000")
            echo "Current health status: $CURRENT_HEALTH"

            # Graceful shutdown
            docker-compose -f ../environments/infrastructure/environments/staging/docker-compose.yml down --timeout 30

            # Pull/build new image
            docker-compose -f ../environments/infrastructure/environments/staging/docker-compose.yml build

            # Start containers
            docker-compose -f ../environments/infrastructure/environments/staging/docker-compose.yml up -d

            # Wait for startup
            sleep 15

            # Health check with retries
            for i in {1..10}; do
              if curl -f http://localhost:8100/health; then
                echo "✅ Health check passed"
                exit 0
              fi
              echo "Waiting for service to start... ($i/10)"
              sleep 5
            done

            echo "❌ Health check failed - rolling back"
            docker-compose -f ../environments/infrastructure/environments/staging/docker-compose.yml down
            exit 1

      - name: Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          script: |
            # Test critical endpoints
            curl -f http://localhost:8100/health || exit 1
            curl -f http://localhost:8100/metrics || exit 1
            echo "✅ Smoke tests passed"

      - name: Verify deployment
        run: |
          echo "✅ Staging deployment completed"
          echo "Environment: staging"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "URL: https://staging.ticker.local"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'staging',
              required_contexts: [],
              auto_merge: false
            });

      - name: Notify deployment (Slack/Discord)
        if: always()
        run: |
          # Add notification logic here
          echo "Deployment status: ${{ job.status }}"
